const uid=new ShortUniqueId({length:10});localforage.config({driver:localforage.INDEXEDDB,description:"Main offline storage backend for open99. Uses IndexedDB."});let sys41={user:{appAddress:"",apps:[{short_name:"bsod",name:"Blue screen of death",action:function(e="Your system encountered an error and needs to reboot",t="Fatal error"){document.body.innerHTML=`\n            <link rel="stylesheet" href="/system/styles/bs.css">\n            <script>function gohome() {window.location.href='/';}<\/script>\n\n            <div onclick="gohome()" onkeydown="gohome()" class="bsod">\n              <span class="title">${t}</span>\n              <p>${e}</p>\n              <p>&bull; Press CTRL+ALT+DEL to reboot your computer - You will<br /> &nbsp; lose any unsaved information in any programs that are running.</p>\n              <a href="/">Press any key to reboot <blink>_</blink></a>\n            </div>\n            `},categories:["Fun"],system:!0,permissions:["administrateSystem"]},{short_name:"reboot",name:"Reboot system",action:function(){location.reload()},categories:["Utility"],system:!0,removeable:!1,permissions:["administrateSystem"]},{short_name:"power",name:"Shut down",action:function(){document.body.innerHTML="",window.close(),self.close()},categories:["Utility"],system:!0,removeable:!1,permissions:["administrateSystem"]},{short_name:"battery",name:"Battery Detector",action:function(){},categories:["System"],system:!0,removeable:!1,permissions:["widget","background"]},{short_name:"antivirus",name:"Antivirus",action:function(){sys41&&sys41.system&&sys41.user&&sys41.user.apps&&sys41.user.profile&&sys41.user.profile.data&&sys41.system.boot||(document.body.innerHTML='\n                <link rel="stylesheet" href="/system/styles/bs.css">\n                <script>function gohome() {window.location.href=\'/\';}<\/script>\n                <div onclick="gohome()" onkeydown="gohome()" class="bsod">\n                  <span class="title">Fatal error</span>\n                  <p>Your computer suffered a fatal error that ocurrs when malicious code runs and removes important parts of the system41 API. You can clear your cache if rebooting doesn\'t work</p>\n                  <p>&bull; Press CTRL+ALT+DEL to reboot your computer - You will<br /> &nbsp; lose any unsaved information in any programs that are running.</p>\n                  <p>&bull; &bull; After this, try rebooting in Safe Mode and clearing all boot scripts. You should also rid your PC of suspicious apps.</p>\n                  <a href="/">Press any key to reboot <blink>_</blink></a>\n                </div>\n                ')},categories:["System"],system:!0,removeable:!0,permissions:["administrateSystem","antivirusBypass"]}],profile:{accountType:null,userName:null,icon:null,background:{type:null,url:null},email:null,firstTime:null}},fs:{get:async function(e){return/^[a-zA-Z]:\/[a-zA-Z]/.test(e)?localforage.getItem(e):/^\/[a-zA-Z]/.test(e)?localforage.getItem(sys41.fs.utils.defaultDrive+e):new Error("Not valid format, check docs")},set:async function(e,t){if(/^[a-zA-Z]:\/[a-zA-Z]/.test(e))localforage.setItem(e,t);else{if(!/^\/[a-zA-Z]/.test(e))return new Error("Not valid format, check docs");localforage.setItem(sys41.fs.utils.defaultDrive+e,t)}return new sys41.fs._File(e,t)},delete:async function(e){if(!sys41.fs.getItem[e])return Error("File doesn't exist");if(/^[a-zA-Z]:\/[a-zA-Z]/.test(e))localforage.removeItem(e,value);else{if(!/^\/[a-zA-Z]/.test(e))return new Error("Not valid format, check docs");localforage.removeItem(sys41.fs.utils.defaultDrive+e,value)}return!0},utils:{config:async function(){await localforage.getItem("_profile")},defaultDrive:"C:"},_File:class{constructor(e,t=localforage.getItem(e)){this.path=e,this.content=t,this.hasContent=!!t,this.drive=e.slice(0,3),this.ext=null,this.mime=null,this.icon=null}}},dom:{boot:document.getElementsByClassName("boot")[0],desktop:document.getElementById("dsktop"),taskbar:document.getElementById("tskbar")},system:{getVersion(){fetch("/version.txt").then((function(e){e.text()})).then(e=>e)},getChannel(){let e;return e="https://open99.ga"===location.href?"main":"https://dev.open99.ga"===location.href?"devel":"illegal",e},boot:{stopped:!1,set:function(e="",t={},s){let n=s||document.createElement("p");return n.innerHTML=e||n.innerHTML,t.icon&&("error"===t.icon&&(n.innerHTML='<p class="error"><span><img class="boot-image" alt="error icon" src="system/assets/98/dialog/error.png"></span>'+e+"</p>",n.classList.add("error")),"success"===t.icon&&(n.innerHTML='<p class="success"><span><img class="boot-image" alt="success check" src="system/assets/98/dialog/check.png"></span>'+e+"</p>",n.classList.add("success")),"warning"===t.icon&&(n.innerHTML='<p class="warning"><span><img class="boot-image" alt="warning icon" src="system/assets/98/dialog/warning.png"></span>'+e+"</p>",n.classList.add("success"))),t.blink&&(n.innerHTML="<blink>"+n.innerHTML+"</blink>"),t.color&&(n.style.color=t.color),s||(document.getElementsByClassName("boot")[0].appendChild(n),n.scrollIntoView()),n},finish:function(){let e=document.getElementsByClassName("boot")[0];e.parentNode.removeChild(e),document.createElement("div").classList.add("postboot")}},themes:{change:function(e=sys41.system.themes.current){sys41.system.themes[e].current=!0},current:null,win7:{url:"system/styles/themes/7.css",abt:"Standard Windows 7 theme. Comes with open99",current:!1,name:"Windows 7",img:null,supports:{ballon:!0,progBar:!0,tabs:!0}},win98:{url:"system/styles/themes/98.css",abt:"Standard Windows 98 theme. Comes with open99 and is the default theme on first boot",current:!0,name:"Windows 98",img:null,supports:{ballon:!1,progBar:!1,tabs:!0}},winxp:{url:"system/styles/themes/xp.css",abt:"Standard Windows XP theme. Comes with open99",current:!1,name:"Windows XP",img:null,supports:{balloon:!1,progBar:!1,tabs:!1}}}},settings:{},ui:{createProgBar:function(e,t){if(!sys41.system.themes.current.supports.progBar)throw Error("Theme "+sys41.system.themes.current.name+" does not support progress bar");{let s=document.createElement("div");s.ariaRoleDescription="progressbar",s.ariaValueMin=t.min,s.ariaValueMax=t.max,s.ariaValueNow=t.now;let n=document.createElement("div");n.style.width=t.width,n.append(s),s.append(e)}},createBalloon:function(e,t){if(!sys41.system.themes.current.supports.balloon&&!sys41.system.themes.current.supports.tooltip)throw Error("Theme "+sys41.system.themes.current.name+" does not support tooltip/balloon");{let s=document.createElement("div");s.ariaRoleDescription="tooltip",s.innerText=t.text,s.append(e)}},cursors:{default:"/system/cursors/default.cur",pointer:"/system/cursors/pointer.cur",text:"/system/cursors/text.cur"}},Window:class{constructor({title:e="",body:t="",draggable:s=!0,dockable:n=!0,icon:o}={}){if(this.title=e,this.body=t,this.draggable=s,n){let e=document.createElement("button");e.innerHTML=`\n        <img src="${o}"><p>${title}</p>\n        `,sys41.dom.tskbar.appendChild(e),this.dockitem=e}else this.dockable=!1;sys41.dom.dsktop.style.cursor="wait",sys41.dom.tskbar.style.cursor="wait";let r=`\n            <div class="title-bar">\n                <div class="title-bar-text">${e}</div>\n                <div class="title-bar-controls">\n                    <button aria-label="Minimize">\n                    <button aria-label="Maximize">\n                    <button aria-label="Close">\n                </div>\n            </div>\n            <div class="window-body">${t}</div>\n        `,i=document.createElement("div");i.className="window",i.innerHTML=r;let l=document.body.appendChild(i);if(s){let e,t,s=null;l.addEventListener("mousedown",(function(n){let o=!1;for(var r=0;n.path[r]!==document.body;r++)if(n.path[r].classList.contains("title-bar"))o=!0;else if(o)return s=n.path[r],s.classList.add("dragging"),e=n.clientX-s.style.left.slice(0,-2),void(t=n.clientY-s.style.top.slice(0,-2))})),l.addEventListener("mouseup",(function(){null!==s&&s.classList.remove("dragging"),s=null})),l.addEventListener("mousemove",(function(n){if(null===s)return;s.style.left=n.clientX-e+"px",s.style.top=n.clientY-t+"px";let o=s.parentElement.getBoundingClientRect(),r=s.getBoundingClientRect();r.left<o.left&&(s.style.left=0),r.top<o.top&&(s.style.top=0),r.right>o.right&&(s.style.left=o.width-r.width+"px"),r.bottom>o.bottom&&(s.style.top=o.height-r.height+"px")}))}else this.draggable=!1;return this.el=l,this}get footer(){return null}set footer(e){return this}get title(){return this.el.firstChild.firstChild.innerText}set title(e){return this.el.firstChild.firstChild.innerText=e,this}close(){this.el.remove(),this.dockitem.remove()}}};const $fs=sys41.fs,$window=sys41.system.createWindow,$prompt=null,$alert=null,$io=null,$url=null,$form=null,$confirm=null,$log=null,win93apis=[$fs,$window,null,null,$io,null,null,null,null];function sleep(e){return new Promise(t=>setTimeout(t,e))}window.onbeforeunload=()=>"Are you sure?";